{% extends "base.html" %}

{% block title %}Summary - Project Management System{% endblock %}

{% block content %}
<div class="row mb-4">
    <div class="col-md-8">
        <h1><i class="fas fa-chart-pie me-2"></i>Project Summary</h1>
        <p class="text-muted">Overview of all projects and their status</p>
    </div>
    <div class="col-md-4 text-end">
        <a href="{{ url_for('index') }}" class="btn btn-outline-primary">
            <i class="fas fa-arrow-left me-1"></i>Back to Dashboard
        </a>
    </div>
</div>

<!-- Global Statistics Cards -->
<div class="row mb-4">
    <div class="col-md-3 mb-3">
        <div class="card text-center">
            <div class="card-body">
                <i class="fas fa-folder-open fa-2x text-primary mb-2"></i>
                <h3 class="card-title">{{ summary.total_projects }}</h3>
                <p class="card-text text-muted">Total Projects</p>
            </div>
        </div>
    </div>
    <div class="col-md-3 mb-3">
        <div class="card text-center">
            <div class="card-body">
                <i class="fas fa-clock fa-2x text-warning mb-2"></i>
                <h3 class="card-title">{{ summary.active_projects }}</h3>
                <p class="card-text text-muted">Active Projects</p>
            </div>
        </div>
    </div>
    <div class="col-md-3 mb-3">
        <div class="card text-center">
            <div class="card-body">
                <i class="fas fa-check-circle fa-2x text-success mb-2"></i>
                <h3 class="card-title">{{ summary.completed_projects }}</h3>
                <p class="card-text text-muted">Completed Projects</p>
            </div>
        </div>
    </div>
    <div class="col-md-3 mb-3">
        <div class="card text-center">
            <div class="card-body">
                <i class="fas fa-percentage fa-2x text-info mb-2"></i>
                <h3 class="card-title">{{ "%.1f"|format(summary.overall_progress * 100) }}%</h3>
                <p class="card-text text-muted">Overall Progress</p>
            </div>
        </div>
    </div>
</div>

<!-- Progress Overview -->
<div class="row mb-4">
    <div class="col-md-8">
        <div class="card">
            <div class="card-header">
                <h5 class="card-title mb-0">
                    <i class="fas fa-chart-bar me-2"></i>Progress Overview
                </h5>
            </div>
            <div class="card-body">
                <div class="mb-4">
                    <div class="d-flex justify-content-between mb-2">
                        <span><strong>Overall Progress</strong></span>
                        <span class="text-muted">{{ "%.1f"|format(summary.overall_progress * 100) }}%</span>
                    </div>
                    <div class="progress mb-3" style="height: 20px;">
                        <div class="progress-bar progress-bar-striped" 
                             style="width: {{ summary.overall_progress * 100 }}%">
                        </div>
                    </div>
                </div>
                
                <div class="row text-center">
                    <div class="col-md-6">
                        <h6 class="text-muted">Stages Progress</h6>
                        <div class="d-flex justify-content-between mb-1">
                            <small>Completed</small>
                            <small>{{ summary.completed_stages }} / {{ summary.total_stages }}</small>
                        </div>
                        <div class="progress" style="height: 8px;">
                            <div class="progress-bar bg-success" 
                                 style="width: {{ (summary.completed_stages / summary.total_stages * 100) if summary.total_stages > 0 else 0 }}%">
                            </div>
                        </div>
                    </div>
                    <div class="col-md-6">
                        <h6 class="text-muted">Tasks Progress</h6>
                        <div class="d-flex justify-content-between mb-1">
                            <small>Completed</small>
                            <small>{{ summary.completed_tasks }} / {{ summary.total_tasks }}</small>
                        </div>
                        <div class="progress" style="height: 8px;">
                            <div class="progress-bar bg-info" 
                                 style="width: {{ (summary.completed_tasks / summary.total_tasks * 100) if summary.total_tasks > 0 else 0 }}%">
                            </div>
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </div>
    <div class="col-md-4">
        <div class="card">
            <div class="card-header">
                <h5 class="card-title mb-0">
                    <i class="fas fa-info-circle me-2"></i>Quick Stats
                </h5>
            </div>
            <div class="card-body">
                <div class="row text-center">
                    <div class="col-6 mb-3">
                        <h4 class="text-primary">{{ summary.total_stages }}</h4>
                        <small class="text-muted">Total Stages</small>
                    </div>
                    <div class="col-6 mb-3">
                        <h4 class="text-success">{{ summary.completed_stages }}</h4>
                        <small class="text-muted">Completed</small>
                    </div>
                    <div class="col-6">
                        <h4 class="text-primary">{{ summary.total_tasks }}</h4>
                        <small class="text-muted">Total Tasks</small>
                    </div>
                    <div class="col-6">
                        <h4 class="text-success">{{ summary.completed_tasks }}</h4>
                        <small class="text-muted">Completed</small>
                    </div>
                </div>
            </div>
        </div>
    </div>
</div>

<!-- Project Breakdown -->
<div class="row">
    <div class="col-12">
        <div class="card">
            <div class="card-header">
                <div class="d-flex justify-content-between align-items-center">
                    <h5 class="card-title mb-0">
                        <i class="fas fa-list me-2"></i>Project Breakdown
                    </h5>
                    <div class="d-flex align-items-center">
                        <label for="sortBy" class="form-label me-2 mb-0">Sort by:</label>
                        <select class="form-select form-select-sm" id="sortBy" style="width: auto;">
                            <option value="name">Project Name</option>
                            <option value="category">Category</option>
                            <option value="progress">Progress</option>
                            <option value="created_at">Date Created</option>
                            <option value="deadline">Deadline</option>
                            <option value="status">Status</option>
                            <option value="completed_tasks">Completed Tasks</option>
                            <option value="total_tasks">Total Tasks</option>
                        </select>
                        <button class="btn btn-sm btn-outline-secondary ms-2" id="sortOrder" onclick="toggleSortOrder()">
                            <i class="fas fa-sort-alpha-down" id="sortIcon"></i>
                        </button>
                    </div>
                </div>
            </div>
            <div class="card-body">
                {% if projects %}
                <div class="table-responsive">
                    <table class="table table-hover" id="projectsTable">
                        <thead>
                            <tr>
                                <th class="sortable-header" data-sort="name" style="cursor: pointer;">
                                    Project Name <i class="fas fa-sort text-muted"></i>
                                </th>
                                <th class="sortable-header" data-sort="category" style="cursor: pointer;">
                                    Category <i class="fas fa-sort text-muted"></i>
                                </th>
                                <th class="sortable-header" data-sort="progress" style="cursor: pointer;">
                                    Progress <i class="fas fa-sort text-muted"></i>
                                </th>
                                <th>Current Stage</th>
                                <th class="sortable-header" data-sort="completed_stages" style="cursor: pointer;">
                                    Stages <i class="fas fa-sort text-muted"></i>
                                </th>
                                <th class="sortable-header" data-sort="completed_tasks" style="cursor: pointer;">
                                    Tasks <i class="fas fa-sort text-muted"></i>
                                </th>
                                <th class="sortable-header" data-sort="status" style="cursor: pointer;">
                                    Status <i class="fas fa-sort text-muted"></i>
                                </th>
                                <th>Actions</th>
                            </tr>
                        </thead>
                        <tbody id="projectsTableBody">
                            {% for project in projects %}
                            <tr data-name="{{ project.name|lower }}" 
                                data-progress="{{ project.overall_progress }}"
                                data-created="{{ project.created_at or '' }}"
                                data-deadline="{{ project.deadline or '' }}"
                                data-status="{% if project.is_completed %}completed{% else %}active{% endif %}"
                                data-completed-tasks="{{ project.completed_tasks }}"
                                data-total-tasks="{{ project.total_tasks }}"
                                data-completed-stages="{{ project.completed_stages }}"
                                data-category="{{ project.category_name or 'uncategorized' }}">
                                <td>
                                    <strong>{{ project.name }}</strong>
                                    {% if project.description %}
                                    <br><small class="text-muted">{{ project.description[:50] }}{% if project.description|length > 50 %}...{% endif %}</small>
                                    {% endif %}
                                </td>
                                <td>
                                    {% if project.category_name %}
                                        <span class="badge bg-secondary">{{ project.category_name }}</span>
                                    {% else %}
                                        <span class="badge bg-light text-dark">Uncategorized</span>
                                    {% endif %}
                                </td>
                                <td>
                                    <div class="progress" style="height: 20px; min-width: 100px;">
                                        <div class="progress-bar" 
                                             style="width: {{ project.overall_progress * 100 }}%">
                                            {{ "%.1f"|format(project.overall_progress * 100) }}%
                                        </div>
                                    </div>
                                </td>
                                <td>
                                    {% if project.current_stage %}
                                        <span class="badge bg-primary">{{ project.current_stage }}</span>
                                    {% else %}
                                        <span class="badge bg-success">Completed</span>
                                    {% endif %}
                                </td>
                                <td>
                                    <small class="text-muted">
                                        {{ project.completed_stages }} / {{ project.total_stages }}
                                    </small>
                                </td>
                                <td>
                                    <small class="text-muted">{{ project.completed_tasks }} / {{ project.total_tasks }}</small>
                                </td>
                                <td>
                                    {% if project.is_completed %}
                                        <span class="badge bg-success">
                                            <i class="fas fa-check me-1"></i>Complete
                                        </span>
                                    {% else %}
                                        <span class="badge bg-primary">
                                            <i class="fas fa-clock me-1"></i>Active
                                        </span>
                                    {% endif %}
                                </td>
                                <td>
                                    <a href="{{ url_for('project_detail', project_id=project.id) }}" 
                                       class="btn btn-sm btn-outline-primary">
                                        <i class="fas fa-eye"></i>
                                    </a>
                                </td>
                            </tr>
                            {% endfor %}
                        </tbody>
                    </table>
                </div>
                {% else %}
                <div class="text-center py-4">
                    <i class="fas fa-folder-open fa-3x text-muted mb-3"></i>
                    <h5 class="text-muted">No Projects Found</h5>
                    <p class="text-muted">Create your first project to see summary statistics.</p>
                    <a href="{{ url_for('index') }}" class="btn btn-primary">
                        <i class="fas fa-plus me-1"></i>Create Project
                    </a>
                </div>
                {% endif %}
            </div>
        </div>
    </div>
</div>
{% endblock %}

{% block scripts %}
<script>
// Project sorting functionality
let sortDescending = false;
let currentSortColumn = 'name';

document.addEventListener('DOMContentLoaded', function() {
    // Add event listener for sort dropdown
    document.getElementById('sortBy').addEventListener('change', sortProjects);
    
    // Add click event listeners to sortable column headers
    document.querySelectorAll('.sortable-header').forEach(header => {
        header.addEventListener('click', function() {
            const sortBy = this.dataset.sort;
            document.getElementById('sortBy').value = sortBy;
            
            // Toggle sort order if clicking the same column
            if (currentSortColumn === sortBy) {
                toggleSortOrder();
            } else {
                // Reset to ascending for new column
                sortDescending = false;
                updateSortOrderIcon();
                currentSortColumn = sortBy;
            }
            
            sortProjects();
            updateHeaderIcons();
        });
    });
});

function toggleSortOrder() {
    sortDescending = !sortDescending;
    updateSortOrderIcon();
    sortProjects();
}

function updateSortOrderIcon() {
    const icon = document.getElementById('sortIcon');
    const button = document.getElementById('sortOrder');
    
    if (sortDescending) {
        icon.className = 'fas fa-sort-alpha-up';
        button.title = 'Descending order';
    } else {
        icon.className = 'fas fa-sort-alpha-down';
        button.title = 'Ascending order';
    }
}

function updateHeaderIcons() {
    // Reset all header icons
    document.querySelectorAll('.sortable-header i').forEach(icon => {
        icon.className = 'fas fa-sort text-muted';
    });
    
    // Update active column icon
    const activeHeader = document.querySelector(`.sortable-header[data-sort="${currentSortColumn}"]`);
    if (activeHeader) {
        const icon = activeHeader.querySelector('i');
        if (sortDescending) {
            icon.className = 'fas fa-sort-up text-primary';
        } else {
            icon.className = 'fas fa-sort-down text-primary';
        }
    }
}

function sortProjects() {
    const sortBy = document.getElementById('sortBy').value;
    const tbody = document.getElementById('projectsTableBody');
    const rows = Array.from(tbody.querySelectorAll('tr'));
    
    // Update current sort column if changed via dropdown
    currentSortColumn = sortBy;
    
    rows.sort((a, b) => {
        let aValue, bValue;
        
        switch (sortBy) {
            case 'name':
                aValue = a.dataset.name;
                bValue = b.dataset.name;
                break;
            case 'category':
                aValue = a.dataset.category;
                bValue = b.dataset.category;
                break;
            case 'progress':
                aValue = parseFloat(a.dataset.progress);
                bValue = parseFloat(b.dataset.progress);
                break;
            case 'created_at':
                aValue = a.dataset.created || '1900-01-01';
                bValue = b.dataset.created || '1900-01-01';
                break;
            case 'deadline':
                aValue = a.dataset.deadline || '9999-12-31';
                bValue = b.dataset.deadline || '9999-12-31';
                break;
            case 'status':
                aValue = a.dataset.status;
                bValue = b.dataset.status;
                // Custom status order: active -> completed
                const statusOrder = { 'active': 0, 'completed': 1 };
                aValue = statusOrder[aValue] || 0;
                bValue = statusOrder[bValue] || 0;
                break;
            case 'completed_tasks':
                aValue = parseInt(a.getAttribute('data-completed-tasks'));
                bValue = parseInt(b.getAttribute('data-completed-tasks'));
                break;
            case 'completed_stages':
                aValue = parseInt(a.getAttribute('data-completed-stages'));
                bValue = parseInt(b.getAttribute('data-completed-stages'));
                break;
            case 'total_tasks':
                aValue = parseInt(a.getAttribute('data-total-tasks'));
                bValue = parseInt(b.getAttribute('data-total-tasks'));
                break;
            default:
                return 0;
        }
        
        if (aValue < bValue) {
            return sortDescending ? 1 : -1;
        }
        if (aValue > bValue) {
            return sortDescending ? -1 : 1;
        }
        return 0;
    });
    
    // Re-append sorted rows
    rows.forEach(row => tbody.appendChild(row));
    
    // Update header icons to show current sort
    updateHeaderIcons();
    
    // Add subtle animation
    tbody.style.opacity = '0.7';
    setTimeout(() => {
        tbody.style.opacity = '1';
    }, 150);
}

// Auto-refresh summary data every 30 seconds
setInterval(async function() {
    try {
        const response = await fetch('/api/summary');
        const summaryData = await response.json();
        
        // Update the progress bars and numbers
        updateSummaryDisplay(summaryData);
    } catch (error) {
        console.warn('Failed to refresh summary data:', error);
    }
}, 30000);

function updateSummaryDisplay(data) {
    // Update overall progress bar
    const progressBar = document.querySelector('.progress-bar-striped');
    if (progressBar) {
        const percentage = (data.overall_progress * 100).toFixed(1);
        progressBar.style.width = `${percentage}%`;
    }
    
    // Update statistics cards (you could add more detailed updates here)
    console.log('Summary updated:', data);
}
</script>
{% endblock %}